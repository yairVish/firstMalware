#include "main.h"
#include <iostream>
#include <direct.h>

using namespace std;

char* Command::run_command(const char* cmd){
	char* output = nullptr;
	string result = "";
	bool need_resp = (string(cmd).rfind(RUN_PROGRAM, 0) == 0);

	if (need_resp) {
		for (int i = 0; i < (strlen((char*)(RUN_PROGRAM)) + 1); i++) {
			cmd++;
		}
	}
	printf("cmd: %s\n", cmd);
	Command::pipe = _popen(cmd, "r");

	if (need_resp)
		return (char*)"run";

	define_result(result);

	output = (char*)malloc(result.length() + 1);
	memcpy(output, result.c_str(), strlen(result.c_str()) + 1);

	string str = remove_substring(string(cmd), " 2>&1");

	if (str == "cd..") {
		_chdir("..");
	}
	else if (str.rfind("cd", 0) == 0) {
		string directory = remove_substring(str, "cd ");
		
		cout << "in: " << directory << endl;
		char* todir = (char*)malloc(directory.length() + 1);
		memcpy(todir, directory.c_str(), strlen(directory.c_str()) + 1);
		cout << "todir: " << todir << endl;
		_chdir(todir);
	}

	_pclose(pipe);
	return output;
}

int Command::define_result(string& result){
	char buffer[BUFFERSIZE];
	try {
		while (fgets(buffer, sizeof buffer, pipe) != NULL) {
			result += buffer;
		}
		if (result == "") {
			result += "\n";
		}
	}catch (...) {
		_pclose(pipe);
		return -1;
	}
	return 0;
}

string Command::remove_substring(std::string str, std::string demo){
	string::size_type size_i = str.find(demo);
	if (size_i != string::npos)
		str.erase(size_i, demo.length());
	return str;
}
