#include "main.h"
using namespace std;

ManagerFile::ManagerFile(SOCKET socketC)
	: OperateSocket(socketC){
}

int ManagerFile::sendFile(LPSTR filename) {
	HANDLE file;
	file = CreateFileA(
		filename,
		GENERIC_READ | GENERIC_WRITE,
		FILE_SHARE_READ,
		NULL,
		OPEN_EXISTING,
		FILE_ATTRIBUTE_NORMAL,
		NULL);
	if (file == INVALID_HANDLE_VALUE) {
		const char* error_msg = ERROR_FILE;
		OperateSocket::send_func((char*)error_msg, strlen(error_msg));
		return -1;
	}
	DWORD file_size = GetFileSize(file, NULL);
	LPVOID buf_file;
	LPSTR data;
	buf_file = malloc(file_size + 1);
	DWORD bytesRead;
	ReadFile(file, buf_file, file_size, &bytesRead, NULL);
	data = (LPSTR)buf_file;
	OperateSocket::send_func(&data[0], file_size);

	CloseHandle(file);
	return 0;
}

int ManagerFile::receiveFile(){
	LPSTR data = nullptr;
	DWORD size_filename = OperateSocket::get_size_pkt();
	LPSTR filename = new char[size_filename];
	OperateSocket::recv_func(&filename[0], size_filename);

	const char* error_msg = ERROR_FILE;
	if (string(filename).rfind(error_msg, 0) == 0)
		return -1;

	DWORD size_img = OperateSocket::get_size_pkt();

	data = new char[size_img +1];
	OperateSocket::recv_func(&data[0], size_img);

	HANDLE file;
	file = CreateFileA(
		filename,
		GENERIC_READ | GENERIC_WRITE,
		0,
		NULL,
		CREATE_ALWAYS,
		FILE_ATTRIBUTE_NORMAL,
		NULL);
	DWORD bytesWrite;
	printf("data: %s\n", data);
	int count = 0;
	WriteFile(file, data, size_img, &bytesWrite, NULL);
	//WriteFile(file, data, strlen(data), &bytesWrite, NULL);
	CloseHandle(file);
	return 0;
}

